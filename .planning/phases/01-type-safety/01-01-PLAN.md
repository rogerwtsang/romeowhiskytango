---
phase: 01-type-safety
plan: 01
type: execute
---

<objective>
Fix critical type errors in simulation core that cause crashes during edge cases.

Purpose: Prevent simulation crashes when player data has None values or when probabilistic baserunning is enabled.
Output: 4 files with fixed type safety, mypy passing on these files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ANALYSIS_NOTES.md

**Key files:**
@src/engine/pa_generator.py
@src/models/baserunning.py
@src/simulation/batch.py
@src/gui/utils/constraint_validator.py

**Established patterns:**
- Type hints on all function signatures
- Optional[T] for nullable parameters
- numpy.random.RandomState for RNG
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pa_generator.py None indexing</name>
  <files>src/engine/pa_generator.py</files>
  <action>
Line 34 indexes `player.pa_probs` which can be None, causing crash.

Add None check before accessing:
```python
probs = player.pa_probs
if probs is None:
    raise ValueError(f"Player '{player.name}' has no PA probabilities calculated")
```

This makes the error explicit rather than crashing with confusing TypeError.
  </action>
  <verify>python -m mypy src/engine/pa_generator.py 2>&1 | grep -c "error" returns 0 (no errors from this file)</verify>
  <done>No mypy errors in pa_generator.py, clear error message when pa_probs is None</done>
</task>

<task type="auto">
  <name>Task 2: Fix baserunning.py rng Optional handling</name>
  <files>src/models/baserunning.py</files>
  <action>
Lines 101, 122, 131 call `rng.random()` but rng is `Optional[np.random.RandomState]`.

The function already raises ValueError at line 63-64 if probabilistic is enabled and rng is None. But mypy can't track this flow.

Fix by adding assert after the check:
```python
if use_probabilistic and rng is None:
    raise ValueError("RNG required when ENABLE_PROBABILISTIC_BASERUNNING is True")

# Help mypy understand rng is not None after this point
assert rng is not None  # Already validated above
```

Alternative: Use `# type: ignore[union-attr]` comments on lines 101, 122, 131 but assert is cleaner.
  </action>
  <verify>python -m mypy src/models/baserunning.py 2>&1 | grep "baserunning.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors related to rng.random() calls</done>
</task>

<task type="auto">
  <name>Task 3: Fix batch.py list/ndarray type confusion</name>
  <files>src/simulation/batch.py</files>
  <action>
Lines 78-83 reassign list variables to numpy arrays, causing 12 mypy errors.
Lines 153-158 then call .tolist() on what mypy thinks are still lists.

Fix by using different variable names for the arrays:
```python
# Lines 78-83: Instead of reassigning, use new names
season_runs_arr = np.array(season_runs)
season_hits_arr = np.array(season_hits)
season_walks_arr = np.array(season_walks)
season_sb_arr = np.array(season_sb)
season_cs_arr = np.array(season_cs)
season_sf_arr = np.array(season_sf)
```

Then update all subsequent code (lines 92-158) to use the `_arr` variants.

The raw_data section (lines 153-158) should use the original lists directly:
```python
raw_data = {
    'season_runs': season_runs,  # Already a list
    'season_hits': season_hits,
    ...
}
```
  </action>
  <verify>python -m mypy src/simulation/batch.py 2>&1 | grep "batch.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors in batch.py, lists and arrays have distinct variable names</done>
</task>

<task type="auto">
  <name>Task 4: Fix constraint_validator.py None comparisons</name>
  <files>src/gui/utils/constraint_validator.py</files>
  <action>
Lines 31, 35, 69, 72, 128 do arithmetic with `position` from constraint.get('position') which can be None.

Add explicit None checks before comparisons:
```python
# Line 31 area - after getting position
position = constraint.get('position')
if position is None:
    return False, "Constraint missing 'position' field"

if position < 1 or position > 9:
    return False, f"Position must be 1-9, got {position}"
```

Apply same pattern to:
- Lines 69-72 (platoon constraint position check)
- Line 128 (apply_constraints position arithmetic)

The fix is adding None validation before using the value.
  </action>
  <verify>python -m mypy src/gui/utils/constraint_validator.py 2>&1 | grep "constraint_validator.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors in constraint_validator.py, all position values validated before use</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m mypy src/engine/pa_generator.py src/models/baserunning.py src/simulation/batch.py src/gui/utils/constraint_validator.py 2>&1 | grep -E "(pa_generator|baserunning|batch|constraint_validator).*error" | wc -l` returns 0
- [ ] `python -c "from src.engine.pa_generator import PAOutcomeGenerator; print('OK')"` succeeds
- [ ] `python -c "from src.models.baserunning import advance_runners; print('OK')"` succeeds
- [ ] `python -c "from src.simulation.batch import run_simulations; print('OK')"` succeeds
</verification>

<success_criteria>

- All 4 files pass mypy without errors from these files
- No regressions - imports still work
- Type safety improvements are minimal and targeted
</success_criteria>

<output>
After completion, create `.planning/phases/01-type-safety/01-01-SUMMARY.md`
</output>
