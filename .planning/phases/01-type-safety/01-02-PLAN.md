---
phase: 01-type-safety
plan: 02
type: execute
---

<objective>
Fix medium priority type errors in models and data processing.

Purpose: Complete type safety pass so mypy runs clean on core modules.
Output: 4 files with fixed type annotations, Phase 1 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-type-safety/01-01-SUMMARY.md

**Key files:**
@src/models/position.py
@src/data/processor.py
@src/models/sacrifice_fly.py
@src/models/stolen_bases.py

**From Plan 01:**
- Type safety patterns established (None checks, explicit validation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix position.py None attribute access</name>
  <files>src/models/position.py</files>
  <action>
Lines 188, 193 access attributes on `FieldingPosition | None` return values.

These are in the `if __name__ == "__main__"` test block. The function `get_position_by_code()` can return None.

Fix by adding None checks before accessing attributes:
```python
pos = get_position_by_code(1)
if pos is not None:
    print(f"Code 1: {pos.abbrev} - {pos.name} ({pos.type})")
else:
    print("Code 1: Not found")
```

Apply same pattern to line 193.
  </action>
  <verify>python -m mypy src/models/position.py 2>&1 | grep "position.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors in position.py</done>
</task>

<task type="auto">
  <name>Task 2: Fix processor.py None dict access</name>
  <files>src/data/processor.py</files>
  <action>
Lines 220, 223 call `.items()` on `dict[str, float] | None`.

These are in the `if __name__ == "__main__"` test block where `player.pa_probs` and `player.hit_dist` could be None.

Fix by adding None checks:
```python
if player.pa_probs is not None:
    for outcome, prob in player.pa_probs.items():
        print(f"    {outcome}: {prob:.4f}")
else:
    print("    (No PA probabilities)")

if player.hit_dist is not None:
    for hit_type, prob in player.hit_dist.items():
        print(f"    {hit_type}: {prob:.4f}")
else:
    print("    (No hit distribution)")
```
  </action>
  <verify>python -m mypy src/data/processor.py 2>&1 | grep "processor.py" | grep -c "error" returns 0 (excluding import-untyped warnings)</verify>
  <done>No mypy type errors in processor.py (import warnings are acceptable)</done>
</task>

<task type="auto">
  <name>Task 3: Fix sacrifice_fly.py type annotations</name>
  <files>src/models/sacrifice_fly.py</files>
  <action>
Lines 75, 82-83, 90, 94 have Dict variance issues in test code.

The issue is passing `dict[str, None]` where `dict[str, Player | None]` is expected. Dict is invariant in its value type.

Fix by properly typing the test dictionaries:
```python
# Instead of:
bases: Dict[str, None] = {'first': None, 'second': None, 'third': None}

# Use explicit type that matches function signature:
from src.models.baserunning import BasesState
bases: BasesState = {'first': None, 'second': None, 'third': None}
```

Or use `Dict[str, Optional[Player]]` explicitly for all test base states.

Also fix line 94 which has a variable type mismatch - ensure the variable receiving the function result has correct type annotation.
  </action>
  <verify>python -m mypy src/models/sacrifice_fly.py 2>&1 | grep "sacrifice_fly.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors in sacrifice_fly.py</done>
</task>

<task type="auto">
  <name>Task 4: Fix stolen_bases.py variable typing in test code</name>
  <files>src/models/stolen_bases.py</files>
  <action>
Lines 243, 272, 280 have type misassignments in the `if __name__ == "__main__"` test block.

Line 243: Variable assigned wrong type (dict vs int)
Lines 272, 280: Variable assigned int when declared as bool

Fix by using different variable names or correcting the types:
```python
# Line 243 - likely meant to be a different variable
bases_state: BasesState = {'first': runner, 'second': None, 'third': None}

# Lines 272, 280 - use proper type
steal_count: int = 0  # Not bool
```

Review the test code logic to understand what types are actually needed and fix accordingly.
  </action>
  <verify>python -m mypy src/models/stolen_bases.py 2>&1 | grep "stolen_bases.py" | grep -c "error" returns 0</verify>
  <done>No mypy errors in stolen_bases.py</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -m mypy src/models/position.py src/data/processor.py src/models/sacrifice_fly.py src/models/stolen_bases.py 2>&1 | grep -E "(position|processor|sacrifice_fly|stolen_bases)\.py.*error" | wc -l` returns 0 (excluding import-untyped)
- [ ] `python -c "from src.models.position import get_position_by_code; print('OK')"` succeeds
- [ ] `python -c "from src.models.sacrifice_fly import check_sacrifice_fly; print('OK')"` succeeds
- [ ] `python -c "from src.models.stolen_bases import calculate_stolen_base_rates; print('OK')"` succeeds
- [ ] Run full mypy check: `python -m mypy src/ --ignore-missing-imports 2>&1 | grep -c "error"` shows significant reduction from original 43+ errors
</verification>

<success_criteria>

- All 4 files pass mypy without errors (except import-untyped warnings for pandas/pybaseball)
- Phase 1 complete - all 8 critical files have type safety fixes
- Total mypy error count reduced from 43+ to near zero on core simulation files
</success_criteria>

<output>
After completion, create `.planning/phases/01-type-safety/01-02-SUMMARY.md` with:
- Summary of all type fixes applied
- Final mypy error count
- Phase 1 marked complete
</output>
