---
phase: 03-gui-foundation
plan: 06
type: execute
wave: 4
depends_on: ["03-05"]
files_modified:
  - src/gui/utils/config_manager.py
  - src/gui/dashboard/main_dashboard.py
autonomous: true

must_haves:
  truths:
    - "User is prompted to restore last session on application startup"
    - "Dashboard state persists between sessions (panel sizes, setup collapsed state, lineups)"
    - "User can choose to start fresh or restore previous session"
  artifacts:
    - path: "src/gui/utils/config_manager.py"
      provides: "Extended ConfigManager with session state persistence"
      contains: "save_session.*load_session"
  key_links:
    - from: "MainDashboard"
      to: "ConfigManager.save_session"
      via: "get_dashboard_state() → JSON"
      pattern: "json\\.dump.*session"
    - from: "ConfigManager.load_session"
      to: "MainDashboard state restoration"
      via: "JSON → set_dashboard_state()"
      pattern: "json\\.load.*session"
---

<objective>
Extend ConfigManager to support session persistence and add startup restoration prompt to MainDashboard.

Purpose: Preserve user's workspace configuration between sessions, reducing setup friction on application restart.

Output: Session management integrated into dashboard with startup restoration prompt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gui-foundation/03-CONTEXT.md
@.planning/phases/03-gui-foundation/03-RESEARCH.md
@src/gui/utils/config_manager.py
@src/gui/dashboard/main_dashboard.py
</context>

<tasks>

<task type="auto">
  <name>Extend ConfigManager for session persistence</name>
  <files>src/gui/utils/config_manager.py</files>
  <action>
Extend ConfigManager class with session state persistence methods.

Add methods:
1. save_session(dashboard_state: dict) -> None:
   - Accepts dashboard_state dict with keys:
     - 'setup_collapsed': bool
     - 'compare_mode': bool
     - 'lineup_panels': list of lineup data dicts
     - 'paned_positions': dict with 'main_vertical' and 'content_horizontal' sash positions
   - Saves to: self.config_dir / 'last_session.json'
   - Use json.dump with indent=2 for human readability
   - Handle IOError gracefully (log or print error, don't crash)

2. load_session() -> Optional[dict]:
   - Loads from: self.config_dir / 'last_session.json'
   - Returns dict if file exists and is valid JSON
   - Returns None if file doesn't exist or is invalid
   - Handle FileNotFoundError and json.JSONDecodeError gracefully

3. session_exists() -> bool:
   - Returns True if last_session.json exists and is valid
   - Quick check for startup prompt decision

Follow RESEARCH.md Pattern 6 (Session State Persistence).

Type hints: from typing import Optional, Dict, Any
Return type for load_session: Optional[Dict[str, Any]]

Google-style docstrings with Args/Returns sections.
Project naming conventions.
  </action>
  <verify>
    - ConfigManager has save_session(), load_session(), session_exists() methods
    - Methods have proper type hints
    - mypy src/gui/utils/config_manager.py shows no errors
    - Test session save/load:
      ```bash
      python -c "
      from src.gui.utils import ConfigManager
      cm = ConfigManager()
      test_state = {'setup_collapsed': True, 'compare_mode': False}
      cm.save_session(test_state)
      loaded = cm.load_session()
      assert loaded == test_state, 'Session save/load failed'
      print('Session persistence works')
      "
      ```
  </verify>
  <done>
ConfigManager extended with save_session(), load_session(), session_exists() methods for JSON-based session persistence.
  </done>
</task>

<task type="auto">
  <name>Add session restoration to MainDashboard</name>
  <files>src/gui/dashboard/main_dashboard.py</files>
  <action>
Add session restoration capability to MainDashboard.

Changes:

1. In __init__, after _create_layout(), add:
   ```python
   self._prompt_session_restore()
   ```

2. Add method _prompt_session_restore():
   - Check if session exists: self.config_manager.session_exists()
   - If exists, show messagebox with yes/no prompt:
     ```python
     from tkinter import messagebox
     restore = messagebox.askyesno(
         "Restore Session",
         "Restore your last session?",
         parent=self
     )
     if restore:
         self._restore_session()
     ```
   - Follow RESEARCH.md Pattern 6

3. Add method _restore_session():
   - Load session: state = self.config_manager.load_session()
   - If state is None, return early
   - Restore setup panel collapse state:
     ```python
     if state.get('setup_collapsed'):
         self.setup_panel.toggle()  # Collapse setup
     ```
   - Restore compare mode:
     ```python
     if state.get('compare_mode') and not self.compare_mode:
         self.toggle_compare_mode()
     ```
   - Restore lineup data:
     ```python
     lineup_data = state.get('lineup_panels', [])
     for i, data in enumerate(lineup_data):
         if i < len(self.lineup_panels):
             self.lineup_panels[i].set_lineup_data(data)
     ```
   - Restore paned positions (if available):
     ```python
     positions = state.get('paned_positions', {})
     if 'main_vertical' in positions:
         self.main_paned.sashpos(0, positions['main_vertical'])
     if 'content_horizontal' in positions:
         self.content_paned.sashpos(0, positions['content_horizontal'])
     ```

4. Update get_dashboard_state() to include paned positions:
   ```python
   return {
       'setup_collapsed': self.setup_panel.collapsed,
       'compare_mode': self.compare_mode,
       'lineup_panels': [panel.get_lineup_data() for panel in self.lineup_panels],
       'paned_positions': {
           'main_vertical': self.main_paned.sashpos(0),
           'content_horizontal': self.content_paned.sashpos(0)
       }
   }
   ```

5. Add method save_session():
   - Calls: self.config_manager.save_session(self.get_dashboard_state())
   - Called from gui.py on exit or save config action

Type hints, docstrings, project conventions.
  </action>
  <verify>
    - MainDashboard has _prompt_session_restore(), _restore_session(), save_session() methods
    - get_dashboard_state() includes paned_positions
    - mypy src/gui/dashboard/main_dashboard.py shows no errors
  </verify>
  <done>
MainDashboard supports session restoration with startup prompt, restoring panel states, lineups, and paned positions.
  </done>
</task>

</tasks>

<verification>
Run mypy:
```bash
mypy src/gui/utils/config_manager.py src/gui/dashboard/main_dashboard.py
```

Test session save/load:
```bash
python -c "
from src.gui.utils import ConfigManager
import json

cm = ConfigManager()
test_state = {
    'setup_collapsed': True,
    'compare_mode': False,
    'lineup_panels': [{'players': ['Player1', 'Player2']}],
    'paned_positions': {'main_vertical': 200, 'content_horizontal': 400}
}

cm.save_session(test_state)
print('Session saved')

loaded = cm.load_session()
assert loaded == test_state, f'Mismatch: {loaded} != {test_state}'
print('Session loaded and verified')

assert cm.session_exists() == True, 'session_exists() failed'
print('All session tests passed')
"
```

Manual test (launch application):
```bash
python gui.py
# 1. Configure dashboard (collapse setup, toggle compare mode, build lineup)
# 2. Exit application (should call save_session)
# 3. Restart application
# 4. Should see "Restore last session?" prompt
# 5. Click Yes - dashboard should restore to previous state
```
</verification>

<success_criteria>
- ConfigManager has session persistence methods (save/load/exists)
- MainDashboard prompts user to restore session on startup
- Session restoration restores: setup collapse state, compare mode, lineup data, paned positions
- get_dashboard_state() captures all necessary state
- Session persists as JSON in ConfigManager directory
- No mypy errors
- Manual test confirms session restoration works
</success_criteria>

<output>
After completion, create `.planning/phases/03-gui-foundation/03-06-SUMMARY.md`
</output>
