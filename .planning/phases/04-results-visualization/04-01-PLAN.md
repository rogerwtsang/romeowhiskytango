---
phase: 04-results-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - src/gui/utils/chart_utils.py
  - src/gui/dashboard/results_panel.py
autonomous: true

must_haves:
  truths:
    - "Histogram shows smooth KDE overlay on distribution"
    - "Mean and CI markers visible on histogram"
    - "Charts reuse helper functions from chart_utils"
  artifacts:
    - path: "requirements.txt"
      provides: "seaborn dependency"
      contains: "seaborn>=0.13.0"
    - path: "src/gui/utils/chart_utils.py"
      provides: "Chart creation helpers"
      exports: ["create_histogram_with_kde", "create_comparison_overlay"]
      min_lines: 80
    - path: "src/gui/dashboard/results_panel.py"
      provides: "Enhanced histogram with KDE"
      contains: "sns.histplot"
  key_links:
    - from: "src/gui/dashboard/results_panel.py"
      to: "src/gui/utils/chart_utils.py"
      via: "import chart_utils functions"
      pattern: "from.*chart_utils.*import"
---

<objective>
Add seaborn dependency and create reusable chart utilities, then enhance the ResultsPanel histogram with KDE overlay for smoother distribution visualization.

Purpose: Establish the chart foundation for Phase 4 visualizations. KDE overlays provide smoother distribution curves that communicate statistical patterns more clearly than raw histograms.
Output: Enhanced histogram in ResultsPanel, reusable chart helper module
</objective>

<execution_context>
@/home/roger/.claude/get-shit-done/workflows/execute-plan.md
@/home/roger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-results-visualization/04-RESEARCH.md
@src/gui/dashboard/results_panel.py
@src/gui/utils/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add seaborn dependency and create chart utilities module</name>
  <files>requirements.txt, src/gui/utils/chart_utils.py, src/gui/utils/__init__.py</files>
  <action>
1. Add `seaborn>=0.13.0` to requirements.txt after matplotlib line

2. Create `src/gui/utils/chart_utils.py` with reusable chart functions:
   - Module header following project conventions
   - `create_histogram_with_kde(ax, data, color='steelblue', show_mean=True, show_median=True, title=None)`:
     - Use sns.histplot(data, kde=True, ax=ax, ...) NOT sns.set_theme() (avoid global state)
     - Add mean/median vertical lines with labels
     - Set axis labels, title, legend, grid
     - Clip x-axis to 0 minimum (ax.set_xlim(0, None)) to avoid negative runs display
   - `create_comparison_overlay(ax, data1, data2, label1, label2, colors=None)`:
     - Overlaid histograms with step element for clarity
     - Mean lines for each distribution
     - Difference annotation
   - `add_effect_size_annotation(ax, data1, data2, x_position=0.95)`:
     - Calculate Cohen's d
     - Add text annotation with magnitude interpretation

3. Export new functions in src/gui/utils/__init__.py

AVOID: Using sns.set_theme() which modifies global matplotlib state. Always pass ax parameter explicitly to seaborn functions.
  </action>
  <verify>
```bash
# Verify seaborn can be imported after pip install
pip install -r requirements.txt && python -c "import seaborn; print(seaborn.__version__)"

# Verify chart_utils module imports
python -c "from src.gui.utils.chart_utils import create_histogram_with_kde, create_comparison_overlay, add_effect_size_annotation; print('OK')"
```
  </verify>
  <done>
- seaborn>=0.13.0 in requirements.txt
- chart_utils.py exists with 3 exported functions
- Functions importable without error
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance ResultsPanel histogram with KDE overlay</name>
  <files>src/gui/dashboard/results_panel.py</files>
  <action>
1. Import chart_utils at top of results_panel.py:
   `from src.gui.utils.chart_utils import create_histogram_with_kde`

2. Modify `_create_histogram()` method to use chart_utils:
   - Replace the current manual ax.hist() + axvline() calls
   - Call `create_histogram_with_kde(self.ax, distribution, show_mean=True, show_median=True, title='Distribution of Runs per Season')`
   - Remove the duplicate mean/median axvline calls (now in chart_utils)
   - Keep the empty data handling ("No data to display" text)
   - Keep figure.tight_layout() and canvas.draw() at end

3. Ensure proper cleanup behavior is maintained:
   - ax.clear() still called before plotting
   - canvas.draw() called after plotting

Memory leak prevention: Do NOT create new Figure objects. Reuse existing self.figure and self.ax by clearing and replotting.
  </action>
  <verify>
```bash
# Run type check
mypy src/gui/dashboard/results_panel.py --ignore-missing-imports

# Verify import chain works
python -c "from src.gui.dashboard.results_panel import ResultsPanel; print('ResultsPanel imports OK')"

# Visual verification requires GUI launch (manual)
```
  </verify>
  <done>
- ResultsPanel histogram shows KDE overlay curve
- Mean and median lines visible on histogram
- No memory leaks (reuses existing figure/axes)
- Type checking passes
  </done>
</task>

</tasks>

<verification>
```bash
# All imports work
python -c "import seaborn; from src.gui.utils.chart_utils import create_histogram_with_kde; from src.gui.dashboard.results_panel import ResultsPanel; print('All imports OK')"

# Type checking
mypy src/gui/utils/chart_utils.py src/gui/dashboard/results_panel.py --ignore-missing-imports

# Quick functional test (creates figure, doesn't display)
python -c "
import numpy as np
from matplotlib.figure import Figure
from src.gui.utils.chart_utils import create_histogram_with_kde
fig = Figure()
ax = fig.add_subplot(111)
data = np.random.normal(700, 50, 1000)
create_histogram_with_kde(ax, data)
print('Histogram function works')
"
```
</verification>

<success_criteria>
- seaborn installed and importable
- chart_utils.py provides reusable histogram and comparison functions
- ResultsPanel histogram enhanced with KDE overlay
- No regressions in existing functionality
- Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-results-visualization/04-01-SUMMARY.md`
</output>
