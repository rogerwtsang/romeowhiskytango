---
phase: 04-results-visualization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/gui/widgets/player_contribution_chart.py
  - src/gui/widgets/__init__.py
  - src/gui/dashboard/results_panel.py
autonomous: true

must_haves:
  truths:
    - "User can see player contributions as bar chart (or placeholder if data unavailable)"
    - "User can toggle between lineup slot view (1-9) and player name view"
    - "Chart is secondary to summary metrics in visual hierarchy (smaller than histogram)"
  artifacts:
    - path: "src/gui/widgets/player_contribution_chart.py"
      provides: "Player contribution chart widget"
      exports: ["PlayerContributionChart"]
      min_lines: 120
    - path: "src/gui/dashboard/results_panel.py"
      provides: "Integrated player contribution view"
      contains: "PlayerContributionChart"
  key_links:
    - from: "src/gui/dashboard/results_panel.py"
      to: "src/gui/widgets/player_contribution_chart.py"
      via: "widget import and instantiation"
      pattern: "PlayerContributionChart\\("
---

<objective>
Create a player contribution visualization widget showing runs produced by lineup slot or individual player, with toggle between views.

Purpose: Help users understand which lineup positions (or players) contribute most to run production. This directly supports the "visual clarity" value and prepares for optimization features.
Output: PlayerContributionChart widget, integrated into ResultsPanel details section
</objective>

<execution_context>
@/home/roger/.claude/get-shit-done/workflows/execute-plan.md
@/home/roger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-results-visualization/04-CONTEXT.md
@.planning/phases/04-results-visualization/04-RESEARCH.md
@src/gui/widgets/__init__.py
@src/gui/dashboard/results_panel.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerContributionChart widget</name>
  <files>src/gui/widgets/player_contribution_chart.py, src/gui/widgets/__init__.py</files>
  <action>
1. Create `src/gui/widgets/player_contribution_chart.py`:

   ```python
   class PlayerContributionChart(ttk.Frame):
       """Chart showing player/slot contributions to run production.

       Displays horizontal bar chart with toggle between:
       - Lineup slot view (positions 1-9)
       - Player name view (individual players)

       Shows placeholder message when contribution data not available
       (data will be provided by optimizer phase in future).
       """

       def __init__(self, parent, **kwargs):
           super().__init__(parent, **kwargs)
           self._view_mode = 'slot'  # 'slot' or 'player'
           self._data = None
           self._create_widgets()

       def _create_widgets(self):
           # Toggle buttons frame
           # - "By Slot" and "By Player" buttons
           # - Use button.config(relief='sunken'/'raised') for toggle state

           # Chart frame with matplotlib figure
           # - Figure(figsize=(5, 3), dpi=100)  # SMALLER than histogram per visual hierarchy
           # - Horizontal bar chart (ax.barh) for readability

       def set_data(self, contribution_data: Optional[Dict[str, Any]]):
           """
           Set contribution data.

           Args:
               contribution_data: Dict with:
                   - slot_contributions: {1: float, 2: float, ...9: float}
                   - player_contributions: {name: float, ...}
                   - player_names: [name1, name2, ...name9] (in lineup order)

                   OR None to show placeholder
           """

       def _toggle_view(self, mode: str):
           """Switch between slot and player view."""

       def _update_chart(self):
           """Redraw chart based on current view mode and data."""
           # Clear axes
           # If no data: show centered text "Contribution data not available"
           # If slot view: barh with labels "1st", "2nd", ..., "9th"
           # If player view: barh with player names
           # Color coding: gradient from high to low contribution
           # Add value labels on bars

       def _show_placeholder(self):
           """Show placeholder when no data available."""
           self.ax.clear()
           self.ax.text(0.5, 0.5, 'Contribution data\nnot yet available',
                       ha='center', va='center', fontsize=10, color='gray',
                       transform=self.ax.transAxes)
           self.ax.axis('off')
           self.canvas.draw()
   ```

2. Use seaborn color palette for bars: `sns.color_palette("Blues_d", n_colors=9)`

3. Export from src/gui/widgets/__init__.py:
   `from .player_contribution_chart import PlayerContributionChart`

NOTE: Per-slot/per-player contribution data is NOT currently tracked by batch.py or the game engine. This widget is built to be ready for when that data becomes available (optimizer phase). For now, it will show a placeholder message.

IMPORTANT: Use figsize=(5, 3) to keep chart secondary to histogram in visual hierarchy, honoring the user decision "Charts secondary to numeric summaries".
  </action>
  <verify>
```bash
# Type check
mypy src/gui/widgets/player_contribution_chart.py --ignore-missing-imports

# Verify import
python -c "from src.gui.widgets import PlayerContributionChart; print('Import OK')"

# Test widget creation with mock data (headless)
python -c "
import tkinter as tk
from src.gui.widgets import PlayerContributionChart

root = tk.Tk()
root.withdraw()  # Hide window
chart = PlayerContributionChart(root)

# Test with None (placeholder)
chart.set_data(None)
print('Placeholder mode OK')

# Test with mock data
mock_data = {
    'slot_contributions': {i: 80 + i*5 for i in range(1, 10)},
    'player_contributions': {f'Player{i}': 80 + i*5 for i in range(1, 10)},
    'player_names': [f'Player{i}' for i in range(1, 10)]
}
chart.set_data(mock_data)
print('Mock data OK')

root.destroy()
"
```
  </verify>
  <done>
- PlayerContributionChart widget exists
- Toggle between slot and player views works
- Bar chart displays with value labels when data available
- Placeholder message shown when data is None
- Widget exported from widgets package
- Figure size (5,3) smaller than histogram to respect visual hierarchy
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PlayerContributionChart into ResultsPanel</name>
  <files>src/gui/dashboard/results_panel.py</files>
  <action>
1. Import PlayerContributionChart at top:
   `from src.gui.widgets import PlayerContributionChart`

2. In `_create_details_section()`, add contribution chart:
   - After histogram section (row 1), add new row (row 2)
   - Create LabelFrame "Player Contributions"
   - Instantiate PlayerContributionChart inside it
   - Store as self.contribution_chart
   - Keep chart compact: the widget's figsize=(5, 3) ensures it's secondary to histogram

3. Update `display_results()` to populate contribution chart:
   ```python
   # Extract contribution data if available
   contribution_data = result_data.get('contributions', None)
   # Pass to widget - it handles None gracefully with placeholder
   self.contribution_chart.set_data(contribution_data)
   ```

4. Update `clear_results()` to clear contribution chart:
   ```python
   self.contribution_chart.set_data(None)  # Shows placeholder
   ```

5. Adjust grid row weights:
   - content.rowconfigure(2, weight=1)  # Contribution chart (same weight as histogram)

NOTE: Until the optimizer phase adds contribution tracking to batch.py, this chart will show a placeholder message. This is intentional - the UI is ready for the data when it becomes available.

VISUAL HIERARCHY: Per user decision, charts are secondary to numeric summaries. The histogram is the primary chart; the contribution chart should be visually subordinate (already handled by figsize=(5,3) in Task 1).
  </action>
  <verify>
```bash
# Type check
mypy src/gui/dashboard/results_panel.py --ignore-missing-imports

# Verify import chain
python -c "from src.gui.dashboard.results_panel import ResultsPanel; print('Import OK')"
```
  </verify>
  <done>
- PlayerContributionChart integrated into ResultsPanel details
- Chart displays placeholder message (data not yet available)
- Chart size respects visual hierarchy (smaller than histogram)
- Graceful handling when data not available
- No regressions in existing ResultsPanel functionality
  </done>
</task>

</tasks>

<verification>
```bash
# Type check all modified files
mypy src/gui/widgets/player_contribution_chart.py src/gui/dashboard/results_panel.py --ignore-missing-imports

# Verify full import chain
python -c "
from src.gui.widgets import PlayerContributionChart
from src.gui.dashboard.results_panel import ResultsPanel
print('All imports OK')
"

# Quick widget test with placeholder and mock data
python -c "
import tkinter as tk
from src.gui.widgets import PlayerContributionChart

root = tk.Tk()
root.withdraw()

chart = PlayerContributionChart(root)

# Test placeholder (what will show until optimizer phase)
chart.set_data(None)
print('Placeholder display OK')

# Test with mock data (preview of future behavior)
chart.set_data({
    'slot_contributions': {i: 80 + i*5 for i in range(1, 10)},
    'player_contributions': {f'Player{i}': 80 + i*5 for i in range(1, 10)},
    'player_names': [f'Player{i}' for i in range(1, 10)]
})
print('Data display OK')
root.destroy()
"
```
</verification>

<success_criteria>
- PlayerContributionChart widget functional
- Toggle between slot and player views works
- Placeholder message displays when no data (current state)
- Bar chart displays contribution values when data provided
- Integrated into ResultsPanel details section
- Chart visually subordinate to histogram (smaller figsize)
</success_criteria>

<output>
After completion, create `.planning/phases/04-results-visualization/04-03-SUMMARY.md`
</output>
