---
phase: 04-results-visualization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/gui/widgets/player_contribution_chart.py
  - src/gui/widgets/__init__.py
  - src/gui/dashboard/results_panel.py
autonomous: true

must_haves:
  truths:
    - "User can see player contributions as bar chart"
    - "User can toggle between lineup slot view (1-9) and player name view"
    - "Contribution metrics show runs produced per player/slot"
  artifacts:
    - path: "src/gui/widgets/player_contribution_chart.py"
      provides: "Player contribution chart widget"
      exports: ["PlayerContributionChart"]
      min_lines: 120
    - path: "src/gui/dashboard/results_panel.py"
      provides: "Integrated player contribution view"
      contains: "PlayerContributionChart"
  key_links:
    - from: "src/gui/dashboard/results_panel.py"
      to: "src/gui/widgets/player_contribution_chart.py"
      via: "widget import and instantiation"
      pattern: "PlayerContributionChart\\("
---

<objective>
Create a player contribution visualization widget showing runs produced by lineup slot or individual player, with toggle between views.

Purpose: Help users understand which lineup positions (or players) contribute most to run production. This directly supports the "visual clarity" value and prepares for optimization features.
Output: PlayerContributionChart widget, integrated into ResultsPanel details section
</objective>

<execution_context>
@/home/roger/.claude/get-shit-done/workflows/execute-plan.md
@/home/roger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-results-visualization/04-CONTEXT.md
@.planning/phases/04-results-visualization/04-RESEARCH.md
@src/gui/widgets/__init__.py
@src/gui/dashboard/results_panel.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerContributionChart widget</name>
  <files>src/gui/widgets/player_contribution_chart.py, src/gui/widgets/__init__.py</files>
  <action>
1. Create `src/gui/widgets/player_contribution_chart.py`:

   ```python
   class PlayerContributionChart(ttk.Frame):
       """Chart showing player/slot contributions to run production.

       Displays horizontal bar chart with toggle between:
       - Lineup slot view (positions 1-9)
       - Player name view (individual players)
       """

       def __init__(self, parent, **kwargs):
           super().__init__(parent, **kwargs)
           self._view_mode = 'slot'  # 'slot' or 'player'
           self._data = None
           self._create_widgets()

       def _create_widgets(self):
           # Toggle buttons frame
           # - "By Slot" and "By Player" buttons
           # - Use button.config(relief='sunken'/'raised') for toggle state

           # Chart frame with matplotlib figure
           # - Figure(figsize=(6, 4), dpi=100)
           # - Horizontal bar chart (ax.barh) for readability

       def set_data(self, contribution_data: Dict[str, Any]):
           """
           Set contribution data.

           Args:
               contribution_data: Dict with:
                   - slot_contributions: {1: float, 2: float, ...9: float}
                   - player_contributions: {name: float, ...}
                   - player_names: [name1, name2, ...name9] (in lineup order)
           """

       def _toggle_view(self, mode: str):
           """Switch between slot and player view."""

       def _update_chart(self):
           """Redraw chart based on current view mode and data."""
           # Clear axes
           # If slot view: barh with labels "1st", "2nd", ..., "9th"
           # If player view: barh with player names
           # Color coding: gradient from high to low contribution
           # Add value labels on bars
   ```

2. Use seaborn color palette for bars: `sns.color_palette("Blues_d", n_colors=9)`

3. Export from src/gui/widgets/__init__.py:
   `from .player_contribution_chart import PlayerContributionChart`

NOTE: The contribution data structure assumes batch.py will provide per-slot or per-player run attribution. If not currently available, the widget should handle missing data gracefully and display a placeholder message.
  </action>
  <verify>
```bash
# Type check
mypy src/gui/widgets/player_contribution_chart.py --ignore-missing-imports

# Verify import
python -c "from src.gui.widgets import PlayerContributionChart; print('Import OK')"

# Test widget creation (headless)
python -c "
import tkinter as tk
from src.gui.widgets import PlayerContributionChart

root = tk.Tk()
root.withdraw()  # Hide window
chart = PlayerContributionChart(root)
print('Widget created OK')
root.destroy()
"
```
  </verify>
  <done>
- PlayerContributionChart widget exists
- Toggle between slot and player views works
- Bar chart displays with value labels
- Widget exported from widgets package
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PlayerContributionChart into ResultsPanel</name>
  <files>src/gui/dashboard/results_panel.py</files>
  <action>
1. Import PlayerContributionChart at top:
   `from src.gui.widgets import PlayerContributionChart`

2. In `_create_details_section()`, add contribution chart:
   - After histogram section (row 1), add new row (row 2)
   - Create LabelFrame "Player Contributions"
   - Instantiate PlayerContributionChart inside it
   - Store as self.contribution_chart

3. Update `display_results()` to populate contribution chart:
   ```python
   # Extract contribution data if available
   contribution_data = result_data.get('contributions', {})
   if contribution_data:
       self.contribution_chart.set_data(contribution_data)
   else:
       # Show placeholder or hide section
       pass
   ```

4. Update `clear_results()` to clear contribution chart

5. Adjust grid row weights:
   - content.rowconfigure(2, weight=1)  # Contribution chart

NOTE: If contribution data is not yet provided by batch.py, the chart should show a placeholder message. This allows the UI to be ready for when the data becomes available.
  </action>
  <verify>
```bash
# Type check
mypy src/gui/dashboard/results_panel.py --ignore-missing-imports

# Verify import chain
python -c "from src.gui.dashboard.results_panel import ResultsPanel; print('Import OK')"
```
  </verify>
  <done>
- PlayerContributionChart integrated into ResultsPanel details
- Chart displays when contribution data available
- Graceful handling when data not available
- No regressions in existing ResultsPanel functionality
  </done>
</task>

</tasks>

<verification>
```bash
# Type check all modified files
mypy src/gui/widgets/player_contribution_chart.py src/gui/dashboard/results_panel.py --ignore-missing-imports

# Verify full import chain
python -c "
from src.gui.widgets import PlayerContributionChart
from src.gui.dashboard.results_panel import ResultsPanel
print('All imports OK')
"

# Quick widget test
python -c "
import tkinter as tk
from src.gui.widgets import PlayerContributionChart

root = tk.Tk()
root.withdraw()

chart = PlayerContributionChart(root)
# Test with mock data
chart.set_data({
    'slot_contributions': {i: 80 + i*5 for i in range(1, 10)},
    'player_contributions': {f'Player{i}': 80 + i*5 for i in range(1, 10)},
    'player_names': [f'Player{i}' for i in range(1, 10)]
})
print('Data set OK')
root.destroy()
"
```
</verification>

<success_criteria>
- PlayerContributionChart widget functional
- Toggle between slot and player views works
- Bar chart displays contribution values
- Integrated into ResultsPanel details section
- Handles missing data gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/04-results-visualization/04-03-SUMMARY.md`
</output>
