---
phase: 05-workflow-polish
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/gui/widgets/lineup_treeview.py
  - src/gui/widgets/__init__.py
  - src/gui/dashboard/lineup_panel.py
  - src/gui/widgets/lineup_builder.py
autonomous: true

must_haves:
  truths:
    - "Lineup displays in spreadsheet-like columns (Pos, Player, Typical Slot, AVG, OBP, SLG, K%)"
    - "Typical batting order position column shows calculated position from historical games started"
    - "Stats are read-only from loaded data"
    - "Drag-and-drop reorders players with insert behavior (not swap)"
    - "Year selection supports single year, career totals, or year range"
  artifacts:
    - path: "src/gui/widgets/lineup_treeview.py"
      provides: "Spreadsheet-like lineup display widget"
      exports: ["LineupTreeview"]
    - path: "src/gui/dashboard/lineup_panel.py"
      provides: "Updated lineup panel using Treeview"
      contains: "LineupTreeview"
  key_links:
    - from: "src/gui/dashboard/lineup_panel.py"
      to: "src/gui/widgets/lineup_treeview.py"
      via: "LineupTreeview widget instantiation"
      pattern: "LineupTreeview"
    - from: "src/gui/widgets/lineup_treeview.py"
      to: "ttk.Treeview"
      via: "Treeview inheritance"
      pattern: "ttk.Treeview"
---

<objective>
Redesign lineup panel with spreadsheet-like Treeview display and drag-and-drop reordering.

Purpose: Make lineup building feel like a database viewer with clean columns and intuitive reordering. Stats display from loaded player data (read-only).

Output:
- LineupTreeview widget with columns (Pos, Player, Typical Slot, AVG, OBP, SLG, K%)
- Typical batting order position calculated from games started data
- Drag-and-drop with insert behavior (not swap)
- Year selection with single year, career totals, or year range modes
</objective>

<execution_context>
@/home/roger/.claude/get-shit-done/workflows/execute-plan.md
@/home/roger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-workflow-polish/05-CONTEXT.md
@.planning/phases/05-workflow-polish/05-RESEARCH.md

# Key source files
@src/gui/dashboard/lineup_panel.py
@src/gui/widgets/lineup_builder.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LineupTreeview widget with drag-and-drop</name>
  <files>src/gui/widgets/lineup_treeview.py, src/gui/widgets/__init__.py</files>
  <action>
Create new LineupTreeview widget in src/gui/widgets/lineup_treeview.py:

1. LineupTreeview(ttk.Frame):
   - Contains ttk.Treeview with columns: ('slot', 'position', 'name', 'typical_slot', 'avg', 'obp', 'slg', 'k_pct')
   - Configure headings: #, Pos, Player, Typ, AVG, OBP, SLG, K%
   - Typical Slot ("Typ") shows typical batting order position calculated from games started at each slot
   - Configure column widths: slot=30, position=50, name=150, typical_slot=40, stats=60 each
   - show='headings' (hide tree column)

2. Drag-and-drop implementation (RESEARCH.md Pattern 2):
   - Bind '<Button-1>' to _on_press: Store drag start index and item
   - Bind '<B1-Motion>' to _on_motion: Visual feedback during drag (optional highlight)
   - Bind '<ButtonRelease-1>' to _on_release: INSERT item at target position
   - INSERT behavior: Remove from old position, insert at new (others shift), not swap

3. Public methods:
   - set_lineup(lineup: List[Optional[Player]]): Populate treeview with 9 slots
   - get_lineup() -> List[Optional[Player]]: Return current lineup order
   - add_player(player: Player, slot: int = None): Add player to slot
   - remove_selected(): Remove selected player from lineup
   - clear_lineup(): Clear all players

4. Typical batting order position calculation:
   - calculate_typical_slot(player: Player) -> int
   - If player has games_by_slot data: return max(games_by_slot.keys(), key=lambda k: games_by_slot[k])
   - Otherwise return 0 (display as "--")
   - Reference RESEARCH.md calculate_typical_slot pattern

5. Display formatting:
   - Empty slots show: "{slot}. (empty)" in gray
   - Filled slots show: "{slot}. {pos} {name} {typical} {stats}"
   - Stats formatted: .3f for AVG/OBP/SLG, .1% for K%
   - Typical slot: Show as integer (1-9) or "--" if no data

6. Scrollbar:
   - Add ttk.Scrollbar for vertical scrolling (height may exceed 9 for roster view)

Add LineupTreeview to src/gui/widgets/__init__.py exports.

Reference RESEARCH.md Patterns 1 and 2 for Treeview and drag-drop implementation.
  </action>
  <verify>
python -c "
from src.gui.widgets import LineupTreeview
import tkinter as tk
root = tk.Tk()
root.withdraw()
lt = LineupTreeview(root)
lt.pack()
print('LineupTreeview created successfully')
# Test empty lineup
lineup = lt.get_lineup()
assert len(lineup) == 9, 'Should have 9 slots'
print(f'Lineup slots: {len(lineup)}')
root.destroy()
"
  </verify>
  <done>LineupTreeview widget exists with spreadsheet columns and drag-and-drop insert behavior</done>
</task>

<task type="auto">
  <name>Task 2: Integrate LineupTreeview into LineupPanel with year selection</name>
  <files>src/gui/dashboard/lineup_panel.py, src/gui/widgets/lineup_builder.py</files>
  <action>
1. In lineup_panel.py, update _create_content():
   - Replace LineupBuilder with LineupTreeview for the batting order display
   - Keep roster listbox on left (for selecting players to add)
   - Add year selection controls above the treeview:
     - ttk.Combobox for year selection (2015-2025)
     - Default to config.CURRENT_SEASON
   - LineupBuilder can be refactored to use LineupTreeview internally, or:
   - Create new two-panel layout: roster list (left) + LineupTreeview (right)

2. Update lineup_builder.py to use LineupTreeview:
   - Replace self.listbox with LineupTreeview for batting order
   - Keep roster_listbox for available players
   - Wire double-click on roster to add to first empty slot in LineupTreeview
   - Wire LineupTreeview's add_player, remove_selected, etc.

3. Year selection with mode toggle:
   - Add ttk.Combobox for mode: ["Single Year", "Career Totals", "Year Range"]
   - For Single Year: Show year_combo with years 2015-2025
   - For Career Totals: Hide year selectors, aggregate all available years
   - For Year Range: Show start_year and end_year comboboxes
   - On mode/year change, reload roster with appropriate stats
   - Default to Single Year with config.CURRENT_SEASON
   - Per-player override option deferred to later plan
   - Reference RESEARCH.md YearSelector pattern

4. Wire existing buttons to LineupTreeview methods:
   - Move Up/Move Down: Use LineupTreeview's internal reorder
   - Remove: Call remove_selected()
   - Clear All: Call clear_lineup()

5. Update get_lineup_data() and set_lineup_data() to use LineupTreeview.
  </action>
  <verify>
python gui.py &
sleep 3
echo "GUI launched - check lineup panel visually"
pkill -f "python gui.py" 2>/dev/null
  </verify>
  <done>LineupPanel uses LineupTreeview with spreadsheet display and year selection dropdown</done>
</task>

</tasks>

<verification>
1. Launch GUI: `python gui.py`
2. Load a team (e.g., TOR 2024)
3. Verify lineup panel shows treeview with columns: #, Pos, Player, Typ, AVG, OBP, SLG, K%
4. Double-click roster player - verify adds to lineup treeview
5. Select player in lineup, drag to new position - verify INSERT behavior (others shift)
6. Test year selection modes:
   - Select "Career Totals" - verify aggregated stats shown
   - Select "Year Range" 2022-2024 - verify combined stats for range
   - Select "Single Year" 2024 - verify single year stats
7. Click Remove - verify selected player removed
8. Click Clear All - verify lineup empties
</verification>

<success_criteria>
- Lineup displays as spreadsheet with columns including Typical batting order position
- Drag-and-drop uses INSERT behavior (not swap)
- Year selection supports single year, career totals, and year range modes
- Stats are read-only, pulled from loaded player data
- Typical slot column shows calculated position from historical data
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-polish/05-03-SUMMARY.md`
</output>
