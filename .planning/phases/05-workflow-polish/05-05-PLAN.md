---
phase: 05-workflow-polish
plan: 05
type: execute
wave: 3
depends_on: [05-03, 05-04]
files_modified:
  - src/gui/dashboard/simulation_panel.py
  - src/gui/dashboard/results_panel.py
  - src/gui/utils/chart_utils.py
  - src/gui/widgets/visuals_panel.py
autonomous: true

must_haves:
  truths:
    - "Visuals tab shows Distribution Histogram (moved from Results)"
    - "Visuals tab shows Player Contributions chart (moved from Results)"
    - "Visuals tab shows Run Expectancy by Slot bar chart"
    - "Visuals tab shows Distribution Overlay for comparing lineups"
    - "Visuals tab shows Player Stat Radar chart for player comparison"
  artifacts:
    - path: "src/gui/widgets/visuals_panel.py"
      provides: "Visuals tab content with all charts"
      exports: ["VisualsPanel"]
    - path: "src/gui/utils/chart_utils.py"
      provides: "New chart functions for radar and run expectancy"
      exports: ["create_radar_chart", "create_run_expectancy_chart", "create_multi_overlay"]
  key_links:
    - from: "src/gui/dashboard/simulation_panel.py"
      to: "src/gui/widgets/visuals_panel.py"
      via: "Visuals tab content"
      pattern: "VisualsPanel"
    - from: "src/gui/widgets/visuals_panel.py"
      to: "src/gui/utils/chart_utils.py"
      via: "chart function calls"
      pattern: "create_(radar|run_expectancy|multi_overlay)"
---

<objective>
Implement Visuals tab with comprehensive chart suite.

Purpose: Consolidate all visualization charts in dedicated Visuals tab, add new charts for run expectancy, distribution overlay, and player radar comparison.

Output:
- VisualsPanel widget with multiple chart sections
- Histogram and Player Contributions moved from Results
- New: Run Expectancy by Slot bar chart
- New: Distribution Overlay (2-4 lineups)
- New: Player Stat Radar chart with percentile toggle
</objective>

<execution_context>
@/home/roger/.claude/get-shit-done/workflows/execute-plan.md
@/home/roger/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-workflow-polish/05-CONTEXT.md
@.planning/phases/05-workflow-polish/05-RESEARCH.md

# Key source files
@src/gui/dashboard/simulation_panel.py
@src/gui/dashboard/results_panel.py
@src/gui/utils/chart_utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new chart functions to chart_utils</name>
  <files>src/gui/utils/chart_utils.py</files>
  <action>
Add three new chart functions to chart_utils.py:

1. create_radar_chart(ax, categories, values_dict, title=None):
   - ax: Matplotlib Axes with polar projection
   - categories: List of stat names ['OBP', 'SLG', 'K%', 'ISO', 'BABIP']
   - values_dict: {player_name: [value1, value2, ...]}
   - Draws radar/spider chart comparing 1-4 players
   - Uses colors from Set2 colormap
   - Reference RESEARCH.md Pattern 6

2. create_run_expectancy_chart(ax, slot_data, title=None):
   - ax: Matplotlib Axes
   - slot_data: Dict[int, float] mapping slot 1-9 to avg runs
   - Creates bar chart showing runs contributed per batting order position
   - X-axis: Slots 1-9, Y-axis: Runs
   - Highlights highest contributor

3. create_multi_overlay(ax, data_dict, bins=30, title=None):
   - ax: Matplotlib Axes
   - data_dict: {label: data_array} for each lineup (max 4)
   - Uses common bin edges for fair comparison
   - Overlays step histograms with transparency
   - Shows mean lines for each distribution
   - Reference RESEARCH.md Pattern 7

4. calculate_axis_lower_bound(data, percentile=1.0):
   - Helper for meaningful axis limits
   - Returns lower bound based on 1st percentile minus padding
   - Reference RESEARCH.md code example

All functions follow existing pattern: explicit ax parameter, no global state.
  </action>
  <verify>
python -c "
from src.gui.utils.chart_utils import create_radar_chart, create_run_expectancy_chart, create_multi_overlay
import matplotlib.pyplot as plt
import numpy as np

# Test radar chart
fig, ax = plt.subplots(subplot_kw=dict(projection='polar'))
categories = ['OBP', 'SLG', 'K%', 'ISO', 'BABIP']
values = {'Player A': [0.8, 0.7, 0.3, 0.6, 0.5]}
create_radar_chart(ax, categories, values)
plt.close()

# Test run expectancy
fig, ax = plt.subplots()
slot_data = {i: 0.5 + i*0.1 for i in range(1, 10)}
create_run_expectancy_chart(ax, slot_data)
plt.close()

# Test multi overlay
fig, ax = plt.subplots()
data = {'A': np.random.normal(700, 30, 100), 'B': np.random.normal(720, 25, 100)}
create_multi_overlay(ax, data)
plt.close()

print('All chart functions work')
"
  </verify>
  <done>chart_utils has create_radar_chart, create_run_expectancy_chart, create_multi_overlay functions</done>
</task>

<task type="auto">
  <name>Task 2: Create VisualsPanel and integrate into SimulationPanel</name>
  <files>src/gui/widgets/visuals_panel.py, src/gui/widgets/__init__.py, src/gui/dashboard/simulation_panel.py, src/gui/dashboard/results_panel.py</files>
  <action>
1. Create src/gui/widgets/visuals_panel.py:
   - VisualsPanel(ttk.Frame) with scrollable content area
   - Sections (each in ttk.LabelFrame):
     a) Distribution Histogram (moved from ResultsPanel)
     b) Player Contributions (moved from ResultsPanel)
     c) Run Expectancy by Slot
     d) Distribution Overlay (compare up to 4 lineups)
     e) Player Stat Radar

   - Each chart section has:
     - ttk.LabelFrame with title
     - matplotlib FigureCanvasTkAgg embedded
     - Clear/refresh button if applicable

   - For Distribution Overlay:
     - Dropdown to select 2-4 lineups from results_manager
     - "Compare" button to render overlay

   - For Player Stat Radar:
     - Multi-select for 1-4 players from roster
     - Toggle: "Raw Values" vs "Percentile Ranks"
     - Stats to show: OBP, SLG, K%, ISO, BABIP

2. Add VisualsPanel to src/gui/widgets/__init__.py exports

3. In simulation_panel.py:
   - Replace placeholder visuals_panel with actual VisualsPanel widget
   - Pass results_manager reference for accessing stored results
   - Pass roster reference for player radar selection

4. In results_panel.py:
   - Remove histogram_frame and contributions_frame from details section
   - Keep only Additional Statistics in details
   - Update display_results() to not create histogram (moved to VisualsPanel)
   - Add method to share result data with VisualsPanel

5. Wire data flow:
   - After simulation completes, update both ResultsPanel (summary) and VisualsPanel (charts)
   - VisualsPanel.set_result_data(result_data) to update histogram and contributions
   - VisualsPanel.set_comparison_data(lineup_results: Dict[str, result]) for overlay
  </action>
  <verify>
python -c "
from src.gui.widgets import VisualsPanel
import tkinter as tk
root = tk.Tk()
root.withdraw()
vp = VisualsPanel(root)
vp.pack()
print('VisualsPanel created successfully')
root.destroy()
"
  </verify>
  <done>VisualsPanel exists with all charts, integrated into SimulationPanel's Visuals tab</done>
</task>

<task type="auto">
  <name>Task 3: Wire VisualsPanel to simulation results</name>
  <files>src/gui/dashboard/main_dashboard.py, src/gui/dashboard/simulation_panel.py</files>
  <action>
1. In simulation_panel.py:
   - Store reference to VisualsPanel: self.visuals_panel
   - Add method set_result_data(result_data) that forwards to VisualsPanel
   - Add method set_roster(roster) for radar chart player selection

2. In main_dashboard.py:
   - In _on_simulation_complete():
     - After displaying in results_panel, also update visuals_panel:
       simulation_panel.set_result_data(normalized_results)
   - In _on_data_loaded():
     - Pass roster to simulation_panel for radar chart

3. For distribution overlay:
   - VisualsPanel gets results_manager reference
   - Dropdown lists stored results by name
   - User selects 2-4 results, clicks "Compare"
   - Calls create_multi_overlay() with selected data

4. For radar chart:
   - VisualsPanel gets roster reference
   - Multi-select (Listbox with selectmode=MULTIPLE) for players
   - Toggle between raw values and percentile ranks
   - Calculate percentiles: (value - min) / (max - min) across roster

5. Meaningful axis limits:
   - Use calculate_axis_lower_bound() for Y-axis on run expectancy
   - Don't start at 0 if all values are clustered high
  </action>
  <verify>
python gui.py &
sleep 3
echo "GUI launched - verify Visuals tab shows charts after simulation"
pkill -f "python gui.py" 2>/dev/null
  </verify>
  <done>VisualsPanel displays charts from simulation results, radar and overlay work with user selection</done>
</task>

</tasks>

<verification>
1. Launch GUI: `python gui.py`
2. Load team and build lineup
3. Run simulation
4. Switch to Visuals tab - verify:
   - Histogram with KDE appears (moved from Results)
   - Player Contributions chart appears
   - Run Expectancy by Slot shows bar chart
5. Run second simulation with different lineup
6. In Distribution Overlay section, select both results and click Compare
7. Verify overlaid histograms appear
8. In Player Stat Radar, select 2-3 players, verify radar chart renders
9. Toggle "Percentile Ranks" - verify chart updates
10. Check Results tab still shows summary stats (not charts)
</verification>

<success_criteria>
- Visuals tab contains all charts (histogram, contributions, run expectancy, overlay, radar)
- Charts update when new simulation completes
- Distribution overlay compares 2-4 saved lineups
- Player radar compares selected players with raw/percentile toggle
- Results tab shows only summary statistics
</success_criteria>

<output>
After completion, create `.planning/phases/05-workflow-polish/05-05-SUMMARY.md`
</output>
