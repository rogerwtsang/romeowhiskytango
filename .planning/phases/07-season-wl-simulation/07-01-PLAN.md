# Plan 07-01: Team W/L Season Simulation Module

**Phase:** 07 - Team W/L Season Simulation
**Plan:** 01 - Core Implementation
**Created:** 2026-01-25
**Based on:** 07-RESEARCH.md

## Goal

Extend the Monte Carlo baseball simulator to predict team wins and losses by adding:
1. Pitching model (FIP-based team aggregation)
2. Opponent modeling (league average initially)
3. Pythagorean W/L conversion from runs scored/allowed
4. International league stat translation (NPB, KBO, LMB, MiLB)

**Success Metric:** Simulate a 162-game season and produce a W/L record with ±8-9 wins accuracy (matching industry standard).

## Scope

**In Scope:**
- Pitcher dataclass and processor
- Team-level pitching aggregation (FIP-based)
- League average opponent model
- Pythagorean expectation W/L calculation
- International league translation factors
- Integration with existing season simulation
- Configuration toggles for new features

**Out of Scope (Future Plans):**
- Pitcher-batter matchup modeling (Bayesian log5)
- Starter vs bullpen distinction
- Rotation/fatigue modeling
- Platoon splits
- Park factor adjustments (defer to 07-02)
- GUI integration (defer to 07-03)

## Prerequisites

- [x] Phase 1 complete (type safety fixes)
- [x] Research complete (07-RESEARCH.md)
- [ ] pybaseball accessible and working

## Architecture

### New Files

```
src/models/pitcher.py              # Pitcher dataclass
src/models/pitching_probability.py # FIP → PA probability adjustment
src/models/opponent.py             # Opponent team model
src/models/league_equivalency.py   # International stat translation
src/data/pitcher_scraper.py        # Fetch pitcher data via pybaseball
src/data/pitcher_processor.py      # Create Pitcher objects from data
src/simulation/wins_losses.py      # Pythagorean W/L calculation
src/simulation/season_wl.py        # Season simulation with W/L output
```

### Modified Files

```
config.py                          # Add pitching model configuration
src/simulation/batch.py            # Add W/L stats to batch output
```

## Tasks

### Wave 1: Data Models (No Dependencies)

#### Task 1.1: Create Pitcher Dataclass
**File:** `src/models/pitcher.py`
**Effort:** Small

Create Pitcher dataclass mirroring Player structure:

```python
@dataclass
class Pitcher:
    name: str
    team: str
    era: float
    fip: float
    xfip: Optional[float] = None
    siera: Optional[float] = None
    k_per_9: float = 8.0
    bb_per_9: float = 3.0
    hr_per_9: float = 1.0
    k_pct: Optional[float] = None
    bb_pct: Optional[float] = None
    ip: float = 0.0
    whip: float = 1.30
    babip: float = 0.300
    lob_pct: float = 0.72
    role: str = 'SP'  # SP, RP, CL
    pa_probs_against: Optional[Dict[str, float]] = None
```

**Verification:**
- [ ] Dataclass instantiates without error
- [ ] All fields have appropriate defaults
- [ ] Type hints pass mypy

---

#### Task 1.2: Create Opponent Model
**File:** `src/models/opponent.py`
**Effort:** Small

Create Opponent dataclass for team-level modeling:

```python
@dataclass
class Opponent:
    name: str
    team_batting_avg: float
    team_obp: float
    team_slg: float
    team_era: float
    team_fip: float
    lineup: Optional[List[Player]] = None
    rotation: Optional[List[Pitcher]] = None

    @classmethod
    def league_average(cls, year: int = 2025) -> 'Opponent':
        """Create opponent representing league average team."""
```

**Verification:**
- [ ] `Opponent.league_average()` returns valid object
- [ ] 2025 league averages are accurate (BA ~.244, OBP ~.312, SLG ~.404, FIP ~4.10)

---

#### Task 1.3: Create League Equivalency Module
**File:** `src/models/league_equivalency.py`
**Effort:** Small

Implement international stat translation:

```python
def translate_foreign_stats(stats: Dict, league: str, age: int) -> Dict:
    """Translate NPB/KBO/LMB/MiLB stats to MLB equivalents."""
```

Translation factors from research:
- NPB: 0.88 (SLG 0.80)
- KBO: 0.80
- LMB: 0.75
- AAA: 0.80
- AA: 0.70

**Verification:**
- [ ] NPB stats reduced appropriately (test with Ohtani's 2017 NPB line)
- [ ] Heavy regression applied (75% league average weight)
- [ ] Age adjustment works (younger = more regression)

---

#### Task 1.4: Add Configuration Constants
**File:** `config.py`
**Effort:** Small

Add pitching model configuration:

```python
# Pitching Model Configuration
ENABLE_PITCHING_MODEL = True
OPPONENT_MODEL_TYPE = 'league_average'  # or 'specific_team'

# League Averages (2025 MLB)
LEAGUE_AVG_FIP = 4.10
LEAGUE_AVG_ERA = 4.20
LEAGUE_AVG_BA = 0.244
LEAGUE_AVG_OBP = 0.312
LEAGUE_AVG_SLG = 0.404

# International League Translation Factors
LEAGUE_EQUIVALENCIES = {
    'NPB': {'ba_factor': 0.90, 'obp_factor': 0.90, 'slg_factor': 0.80, 'k_pct_factor': 1.15},
    'KBO': {'ba_factor': 0.85, 'obp_factor': 0.85, 'slg_factor': 0.75, 'k_pct_factor': 1.20},
    'LMB': {'ba_factor': 0.80, 'obp_factor': 0.80, 'slg_factor': 0.70, 'k_pct_factor': 1.25},
    'AAA': {'ba_factor': 0.85, 'obp_factor': 0.85, 'slg_factor': 0.80, 'k_pct_factor': 1.15},
    'AA': {'ba_factor': 0.80, 'obp_factor': 0.80, 'slg_factor': 0.70, 'k_pct_factor': 1.25},
}

# Sample Size Thresholds
MIN_IP_FOR_STARTER = 50
MIN_IP_FOR_RELIEVER = 20

# Pythagorean Exponent
PYTHAGOREAN_EXPONENT = 1.83
```

**Verification:**
- [ ] All constants defined with documented sources
- [ ] Toggle `ENABLE_PITCHING_MODEL` exists
- [ ] No import errors from config.py

---

### Wave 2: Data Loading (Depends on Wave 1)

#### Task 2.1: Create Pitcher Scraper
**File:** `src/data/pitcher_scraper.py`
**Effort:** Medium

Fetch pitcher data via pybaseball:

```python
def get_team_pitching_stats(team: str, season: int) -> pd.DataFrame:
    """Fetch team pitching statistics from FanGraphs via pybaseball."""

def get_league_average_pitching(season: int) -> Dict:
    """Calculate league-wide average pitching statistics."""
```

Use `pitching_stats()` from pybaseball with qual=50 for starters, qual=20 for relievers.

**Verification:**
- [ ] Returns DataFrame with expected columns (Name, Team, ERA, FIP, K/9, BB/9, HR/9, IP)
- [ ] Team filter works correctly
- [ ] League average calculation matches published FanGraphs data
- [ ] Handles network errors gracefully (try/except with fallback)

---

#### Task 2.2: Create Pitcher Processor
**File:** `src/data/pitcher_processor.py`
**Effort:** Medium

Transform pybaseball data into Pitcher objects:

```python
def create_pitcher_from_stats(row: pd.Series) -> Pitcher:
    """Create Pitcher object from pybaseball DataFrame row."""

def get_team_aggregate_fip(pitchers: List[Pitcher]) -> float:
    """Calculate IP-weighted team FIP from pitcher list."""
```

**Verification:**
- [ ] Creates valid Pitcher objects from real data
- [ ] Handles missing columns with sensible defaults
- [ ] Team aggregate FIP weighted by IP
- [ ] Role detection works (SP if GS >= G/2)

---

### Wave 3: Probability Model (Depends on Wave 1)

#### Task 3.1: Create Pitching Probability Module
**File:** `src/models/pitching_probability.py`
**Effort:** Medium

Decompose FIP into PA outcome adjustments:

```python
def decompose_fip(fip: float, k_pct: float, bb_pct: float, hr_per_9: float) -> Dict[str, float]:
    """Decompose FIP into PA outcome probabilities."""

def adjust_pa_probs_for_pitcher(pa_probs: Dict[str, float], opponent_fip: float,
                                 league_avg_fip: float = 4.10) -> Dict[str, float]:
    """Adjust batter PA probabilities based on opposing pitcher quality."""
```

Key logic:
- Better pitcher (lower FIP) → fewer hits, more strikeouts
- FIP factor = league_avg_fip / opponent_fip
- Clamp adjustment to 0.75-1.25 range
- Normalize probabilities to sum to 1.0

**Verification:**
- [ ] Excellent pitcher (FIP 2.80) reduces hit probability
- [ ] Poor pitcher (FIP 5.50) increases hit probability
- [ ] League average (FIP 4.10) leaves probabilities unchanged
- [ ] Probabilities always sum to 1.0

---

### Wave 4: W/L Calculation (Depends on Wave 3)

#### Task 4.1: Create Wins/Losses Module
**File:** `src/simulation/wins_losses.py`
**Effort:** Small

Implement Pythagorean expectation:

```python
def pythagorean_win_pct(runs_scored: float, runs_allowed: float,
                        exponent: float = 1.83) -> float:
    """Calculate expected win percentage using Pythagorean formula."""

def pythagorean_wins(runs_scored: float, runs_allowed: float,
                     games: int = 162, exponent: float = 1.83) -> Dict:
    """Calculate expected wins/losses from runs scored/allowed."""

def runs_for_wins(target_wins: int, runs_allowed: float,
                  games: int = 162, exponent: float = 1.83) -> float:
    """Calculate runs needed to achieve target wins (inverse formula)."""
```

**Verification:**
- [ ] 2024 Dodgers (842 RS, 644 RA) → ~100 expected wins (actual: 98)
- [ ] League average (700 RS, 700 RA) → 81 wins
- [ ] Division by zero handled (RA=0 edge case)

---

#### Task 4.2: Create Season W/L Simulation
**File:** `src/simulation/season_wl.py`
**Effort:** Medium

Integrate W/L calculation with existing season simulation:

```python
def simulate_season_with_wl(
    lineup: List[Player],
    team_pitching_fip: float,
    opponent: Opponent,
    pa_generator: PAOutcomeGenerator,
    n_games: int = 162
) -> Dict:
    """Simulate season and estimate W/L record."""
```

Flow:
1. Simulate offensive performance (existing `simulate_season`)
2. Estimate runs allowed from team pitching FIP
3. Apply Pythagorean expectation
4. Return combined results

**Verification:**
- [ ] Returns runs scored, runs allowed, expected W/L
- [ ] Works with league average opponent
- [ ] W/L record is reasonable (70-92 wins for typical team)
- [ ] Reproducible with same random seed

---

### Wave 5: Integration (Depends on Waves 2, 4)

#### Task 5.1: Update Batch Simulation
**File:** `src/simulation/batch.py`
**Effort:** Medium

Add W/L statistics to batch output:

```python
def run_simulations_with_wl(
    lineup: List[Player],
    team_pitching_fip: float,
    opponent: Opponent,
    n_iterations: int,
    n_games: int = 162,
    random_seed: Optional[int] = None,
    progress_callback: Optional[Callable] = None
) -> Dict:
    """Run multiple season simulations with W/L tracking."""
```

Output should include:
- Mean/median/std for wins, losses, win_pct
- Confidence intervals (5th, 25th, 75th, 95th percentile)
- Runs scored/allowed per game averages
- All existing batting statistics

**Verification:**
- [ ] Batch output includes W/L statistics
- [ ] Confidence intervals calculated correctly
- [ ] Progress callback still works
- [ ] 100 iterations completes in reasonable time (<60s)

---

#### Task 5.2: Create Integration Test Script
**File:** `scripts/validate_wl_simulation.py`
**Effort:** Medium

Validation script to test W/L simulation accuracy:

```python
def validate_against_historical(team: str, season: int):
    """Compare simulated W/L to actual historical record."""
```

Test cases:
1. 2024 Dodgers: Actual 98-64, RS=842, RA=644
2. 2024 Blue Jays: Actual 74-88, RS=692, RA=751
3. 2024 Phillies: Actual 95-67, RS=799, RA=636

**Verification:**
- [ ] Script runs without error
- [ ] Simulated wins within 8-9 of actual (expected accuracy)
- [ ] Pythagorean wins match known values
- [ ] Output clearly shows comparison

---

### Wave 6: Documentation (Depends on Wave 5)

#### Task 6.1: Update CLAUDE.md
**File:** `CLAUDE.md`
**Effort:** Small

Add documentation for new module:
- New files and their purposes
- How to run W/L simulation
- Configuration options
- Limitations and accuracy expectations

**Verification:**
- [ ] New files documented
- [ ] Usage examples included
- [ ] Limitations clearly stated

---

## Execution Order

```
Wave 1 (Parallel - No Dependencies):
├── Task 1.1: Pitcher dataclass
├── Task 1.2: Opponent model
├── Task 1.3: League equivalency
└── Task 1.4: Configuration

Wave 2 (Depends on Wave 1):
├── Task 2.1: Pitcher scraper
└── Task 2.2: Pitcher processor

Wave 3 (Depends on Wave 1):
└── Task 3.1: Pitching probability

Wave 4 (Depends on Wave 3):
├── Task 4.1: Wins/losses module
└── Task 4.2: Season W/L simulation

Wave 5 (Depends on Waves 2, 4):
├── Task 5.1: Batch integration
└── Task 5.2: Validation script

Wave 6 (Depends on Wave 5):
└── Task 6.1: Documentation
```

## Verification Checklist

### Unit Tests
- [ ] `test_pitcher_dataclass()` - Pitcher creation and defaults
- [ ] `test_opponent_league_average()` - League average opponent
- [ ] `test_league_equivalency_npb()` - NPB translation
- [ ] `test_pythagorean_wins()` - W/L calculation
- [ ] `test_fip_adjustment()` - PA probability adjustment

### Integration Tests
- [ ] `test_load_team_pitching()` - pybaseball integration
- [ ] `test_season_wl_simulation()` - End-to-end simulation
- [ ] `test_batch_wl_output()` - Batch statistics

### Validation
- [ ] 2024 Dodgers within 8-9 wins of actual
- [ ] 2024 Blue Jays within 8-9 wins of actual
- [ ] Pythagorean residuals reasonable (<5 wins)

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| pybaseball API changes | Pin version, add fallback to cached data |
| Network failures | Cache pitcher data locally, retry logic |
| Accuracy worse than expected | Validate incrementally, tune FIP adjustment factor |
| Performance issues | Profile batch simulation, optimize if >60s for 100 iterations |

## Future Plans (Out of Scope)

**07-02: Park Factors and Adjustments**
- Apply park factors to batting/pitching stats
- Home/away split modeling

**07-03: GUI Integration**
- Add pitcher loading to Setup tab
- Display W/L projection in Results panel
- Rotation builder (optional)

**07-04: Advanced Matchup Modeling**
- Pitcher-batter Bayesian log5
- Platoon splits
- Starter vs bullpen distinction

## Notes

- **Accuracy expectation:** 8-9 wins RMSE is state-of-the-art; don't over-engineer
- **Simplicity:** Team-level FIP aggregation is sufficient; avoid pitcher-batter matchups
- **Regression:** International league stats need heavy regression (75% league average)
- **Data source:** pybaseball provides all needed MLB pitching data
- **International data:** NPB/KBO/LMB requires manual CSV import (not in pybaseball)
